
@{
	ViewBag.Title = "";
	Layout = "~/Areas/Mobile/Views/Shared/_Layout.cshtml";
}

<div id="mymerchantbargainorderdetails">
	<img class="return-img" src="~/Areas/resource/img/mobile/return-circle.png" v-on:click="back" />
	<div class="main">
		<div class="bargainorder-con">
			<div>
				<img class="bargainorder-img" v-bind:src=MerchantBargainOrderRecord.ImgUrl />
			</div>
			<div class="bargainorder-name">{{MerchantBargainOrderRecord.ProductName}}</div>
			<div class="cbctable bargainorder-price-con width-fill">
				<div class="cbctablecell bargainorder-price"><span style="font-size:13px;">￥</span>{{MerchantBargainOrderRecord.Price}}</div>
				<div class="cbctablecell bargainorder-pricesale">￥{{MerchantBargainOrderRecord.PriceSale}}</div>
				@*<div class="cbctablecell bargainorder-count">已拼666件</div>*@
			</div>
			<div class="bargainorder-name">{{MerchantBargainOrderRecord.Name}}</div>
		</div>
		<div class="peoplecount-con">已有<span style="color:#e02d28;margin:0 3px;">{{MerchantBargainOrderRecord.JoinPeople}}</span>人参与<span style="font-size:13px;">（最多<span style="color:#e02d28;">{{MerchantBargainOrderRecord.PeopleCount}}</span>人参与）</span><span style="float:right;background-color:red;padding:2px 6px 2px 6px;border-radius:5px;color:white;" v-on:click="flash">刷新</span></div>
		<div v-for="Item in MerchantBargainOrderRecord.MerchantBargainOrderRecordItemList">
			<div class="peoplecount-con" v-if="MerchantBargainOrderRecord.MemberID!=Item.MemberID"><span style="color:red">{{Item.MemberName}}</span>帮您砍了：<span style="font-size:13px;">￥</span>{{Item.Price}}</div>
		</div>
	</div>
	<div class="bottomactioncon" v-on:click="join" v-bind:class="bargainClass">
		<div>￥{{MerchantBargainOrderRecord.FinalPrice}}</div>
		<div>帮兄弟砍个价,谢了!</div>
	</div>
	<div class="bottomactioncon" v-on:click="buy" v-if="!MerchantBargainOrderRecord.IsOrdered&&MerchantBargainOrderRecord.MemberID==MyInfo.ID" v-bind:class="buyClass">
		<div>￥{{MerchantBargainOrderRecord.FinalPrice}}</div>
		<div>立即下单</div>
	</div>
	<div class="bottomactioncon" v-if="MerchantBargainOrderRecord.IsOrdered">
		<div>￥{{MerchantBargainOrderRecord.FinalPrice}}</div>
		<div>已下单</div>
	</div>
</div>

@section scripts{
	<style type="text/css">
		.main {
			background: #f5f5f4;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 50px;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}

		.cbctable {
			display: table;
		}

		.cbctablecell {
			display: table-cell;
		}

		.bottomactioncon {
			height: 50px;
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			width: 100%;
			text-align: center;
			background: #e02d28;
			color: #fff;
			font-size: 15px;
		}

		.bargainorder-con {
			background: #fff;
		}

		.bargainorder-img {
			width: 100%;
			height: 250px;
		}

		.width-fill {
			width: 100%;
		}

		.bargainorder-name {
			font-size: 15px;
			padding: 0px 13px 10px 13px;
		}

		.bargainorder-price-con {
			margin: 0 0px 5px 0px;
		}

		.bargainorder-price {
			font-size: 23px;
			color: #e80c1c;
			width: 60px;
			padding: 0 10px 0 13px;
		}

		.bargainorder-pricesale {
			font-size: 13px;
			color: #545456;
			text-decoration: line-through;
		}

		.bargainorder-count {
			font-size: 13px;
			color: #a8a8a8;
			float: right;
			margin-right: 13px;
		}

		.peoplecount-con {
			height: 30px;
			line-height: 30px;
			padding: 5px 13px;
			background: #fff;
			font-size: 15px;
			margin-top: 3px;
			letter-spacing: 1px;
		}

		.bargainorderrules-con {
			padding: 10px 13px;
			background: #fff;
			font-size: 13px;
			margin-top: 3px;
			letter-spacing: 1px;
			color: #58585a;
		}

		.return-img {
			width: 33px;
			position: fixed;
			top: 20px;
			left: 20px;
			z-index: 1;
			opacity: 0.5;
		}

		.show {
			display: inline;
		}

		.hide {
			display: none;
		}
	</style>
	<link type="text/css" href="~/Areas/resource/css/mobile/customer.css" />
	<link href="~/Areas/resource/css/mobile/customer.css" rel="stylesheet" type="text/css" />
	<script src="//cdn.bootcss.com/vue/2.1.10/vue.min.js"></script>
	<script type="text/javascript" src="//res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	<script type="text/javascript">
        $(function () {
            var mch = $.getUrlParam('mch');
			var bargainid = $.getUrlParam('bargainid');
			var isadd = $.getUrlParam('isadd') == 'true';
			IsBargained = false;
			if (isadd) {
				$.alert('点击右上角分享朋友/朋友圈，开始砍价！');
				IsBargained = true;
            }
            var bargainid = $.getUrlParam('bargainid');
			var merchantbargainorderrecord = sessionStorage.getItem('merchantbargainorderrecord');
			merchantbargainorderrecord = JSON.parse(merchantbargainorderrecord);
			_viewModel = new Vue({
				el: '#mymerchantbargainorderdetails',
				data: {
					MyInfo: {},
					MerchantBargainOrderRecord: {},
					IsMember: false,
					IsBargained: IsBargained,
				},
				computed: {
					bargainClass: function () {
						return {
							show: !this.IsBargained,
							hide: this.IsBargained,
						}
					},
					buyClass: function () {
						return {
							show: this.IsBargained,
							hide: !this.IsBargained,
						}
					}
				},
            methods: {
                register: function (event) {
                    if (!_viewModel.IsMember)
                        window.location.href = "/Mobile/Customer/Index?mch=" + mch;
                },
				back: function (event) {
					sessionStorage.setItem('showorder', 3);
					window.location.href = "/Mobile/Customer/MyOrder?mch=" + mch;
				},
				join: function (event) {
					if (_viewModel.MerchantBargainOrderRecord.JoinPeople <= _viewModel.MerchantBargainOrderRecord.PeopleCount) {
						$.ajax({
							url: '/api/MerchantBargainOrderRecord/AddMerchantBargainOrderRecordItem',
							type: 'POST',
							data: {
								MerchantBargainOrderRecordID: _viewModel.MerchantBargainOrderRecord.ID,
								MemberID: _viewModel.MyInfo.ID,
							},
							headers: { 'CompanyCode': mch },
							beforeSend: function () {
								$.showLoading();
							},
							success: function (res) {
								$.hideLoading();
								if (res.IsSuccessful) {
									if (res.Data != null) {
										_viewModel.MerchantBargainOrderRecord.JoinPeople = res.Data.JoinPeople;
										_viewModel.IsBargained = true;
										$.alert('您已加入发起砍价成功，请点击右上角分享朋友/朋友圈，让优惠进行到底！');
										window.location.reload();
									}
								} else {
									$.alert(res.ErrorMessage);
								}
							},
							error: function () {
								$.hideLoading();
							}
						});
					} else {
						$.alert('砍价人数已达上限');
					}
				},
                buy: function (event) {
                    $.confirm('立即下单', function () {
                        _viewModel.MerchantBargainOrderRecord.Product.PriceSale = _viewModel.MerchantBargainOrderRecord.FinalPrice;
                        sessionStorage.setItem('product', JSON.stringify(_viewModel.MerchantBargainOrderRecord.Product));
                        sessionStorage.setItem('isfromcod', 'true');
						sessionStorage.setItem('bargainid', _viewModel.MerchantBargainOrderRecord.ID);
                        window.location.href = "/Mobile/Customer/ProductDetails?mch=" + mch;
                    });
				},
				flash: function (event) { 
					getmymerchantorder(bargainid);
				}
            }
            });
			if (merchantbargainorderrecord != null && merchantbargainorderrecord != '') {
				_viewModel.MerchantBargainOrderRecord = merchantbargainorderrecord;
			}

            function getmymerchantorder(id) {
                $.ajax({
                    url: '/api/MerchantBargainOrderRecord?ID=' + id,
                    type: 'GET',
                    headers: { 'CompanyCode': mch },
                    beforeSend: function () {
                        $.showLoading();
                    },
                    success: function (res) {
                        $.hideLoading();
                        if (res.IsSuccessful) {
                            if (res.Data != null) {
                                _viewModel.MerchantBargainOrderRecord = res.Data[0];
                                getMember(_viewModel.MerchantBargainOrderRecord);
                            }
                        } else {
                            $.alert(res.ErrorMessage);
                        }
                    },
                    error: function () {
                        $.hideLoading();
                    }
                });
            }

            function getMember(bargainorder) {
				$.ajax({
					url: '/api/Member?WeChatOpenID=@ViewBag.OpenId',
					type: 'GET',
					headers: { 'CompanyCode': mch },
					beforeSend: function () {
						$.showLoading();
					},
					success: function (res) {
						$.hideLoading();
						if (res.IsSuccessful) {
							if (res.Data != null) {
								if (res.Data.length > 0) {
									_viewModel.MyInfo = res.Data[0];
									_viewModel.IsMember = true;
									_viewModel.MerchantBargainOrderRecord.MerchantBargainOrderRecordItemList.forEach(function (item) {
										if (item.MemberID == _viewModel.MyInfo.ID) {
											_viewModel.IsBargained = true;
										}
									});
								} else {
									window.location.href = "/Mobile/Customer/Index?mch=" + mch + "&bargainid=" + bargainid;
								}
							} else {
								if (bargainid != null && bargainid != "") {
									window.location.href = "/Mobile/Customer/Index?mch=" + mch + "&bargainid=" + bargainid;
								}
							}
						} else {
							$.alert(res.ErrorMessage);
						}
					},
					error: function () {
						$.hideLoading();
					}
				});
			}

			var member = sessionStorage.getItem('member');
            if (member == null || member == '') {
                var mch = $.getUrlParam('mch');
                function init() {
                    $.ajax({
                        url: '/api/Member/GetMemberInfoByWeChat?openID=@ViewBag.OpenId',
                        type: 'GET',
                        headers: { 'CompanyCode': mch },
                        beforeSend: function () {
                            $.showLoading();
                        },
                        success: function (res) {
                            $.hideLoading();
                            if (res.IsSuccessful) {
                                if (res.Data != null) {
                                    member = res.Data;
                                    sessionStorage.setItem('member', JSON.stringify(res.Data));
                                } else {
                                    window.location.href = "/Mobile/Customer?mch=" + mch;
                                }
                            } else {
                                $.alert(res.ErrorMessage);
                                window.location.href = "/Mobile/Customer?mch=" + mch;
                            }
                        },
                        error: function () {
                            $.hideLoading();
                            window.location.href = "/Mobile/Customer?mch=" + mch;
                        }
                    });
                }
                init();
            } else {
                member = JSON.parse(member);
			}

			if (bargainid != null && bargainid != "") {
				getmymerchantorder(bargainid);
            } else {
                getMember(merchantbargainorderrecord);
            }

            function wxConfig() {
                $.ajax({
                    type: "POST",
                    url: "http://www.cheyinz.cn/wxis/api/WeChat/JsApiSignature?companyCode=" + mch + "&url=" + encodeURIComponent(document.URL),
                    datatype: "json",
                    success: function (data) {
                        if (data.IsSuccessful) {
                            var temp = data.Data;
                            wx.config({
                                debug: false,
                                appId: temp.appId,
                                timestamp: temp.timestamp,
                                nonceStr: temp.nonceStr,
                                signature: temp.signature,
                                jsApiList: [
                                    'checkJsApi',
                                    'onMenuShareTimeline',
                                    'onMenuShareAppMessage',
                                    'onMenuShareQQ',
                                    'onMenuShareWeibo',
                                    'hideOptionMenu',
                                    'hideAllNonBaseMenuItem',
                                    'showMenuItems',
                                    'closeWindow',
                                    'scanQRCode',
                                ]
                            });
                            wx.ready(function () {
                                //wx.hideAllNonBaseMenuItem();
                                console.log('ready');
                                wx.onMenuShareAppMessage({
                                    title: "【砍价】"+_viewModel.MerchantBargainOrderRecord.Name,
                                    desc: '砍价助力！分享即享低价！',
									link: document.URL.replace('isadd=true', 'isadd=false') + '&bargainid=' + _viewModel.MerchantBargainOrderRecord.ID,
									imgUrl: document.location.origin + _viewModel.MerchantBargainOrderRecord.ImgUrl,
                                    success: function (res) {
                                    }
                                });
                                wx.onMenuShareTimeline({
									title: "【砍价】" + _viewModel.MerchantBargainOrderRecord.Name, // 分享标题
									link: document.URL.replace('isadd=true', 'isadd=false') + '&bargainid=' + _viewModel.MerchantBargainOrderRecord.ID, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
									imgUrl: document.location.origin + _viewModel.MerchantBargainOrderRecord.ImgUrl, // 分享图标
                                    success: function () {
                                        // 用户点击了分享后执行的回调函数
                                    }
                                });
                            });
                            } else {
                        }
                    },
                    complete: function (xmlHttpRequest, textStatus) {
                    },
                    error: function (xmlHttpRequest, textStatus) {
                    }
                });
            };
            wxConfig();

        });
	</script>
}
}


